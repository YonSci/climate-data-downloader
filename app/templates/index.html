<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Ensure proper scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Climate & Geo-Spatial Data Downloader</title>
  <!-- Using Bootswatch Flatly theme for Bootstrap 5 for a modern, clean, accessible UI -->
  <link rel="stylesheet" href="https://bootswatch.com/5/flatly/bootstrap.min.css" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body { padding-top: 60px; }
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: #0576ee;
      color: white;
      padding: 8px;
      z-index: 100;
    }
    .skip-link:focus { top: 0; }
    #confirmationCard, #urlCard { display: none; }
    #spatial_map { height: 300px; margin-top: 1rem; }
    #spinner, #spinnerText {
      display: none;
      text-align: center;
      margin-top: 1rem;
    }
  </style>
  <!-- Include shp.js if needed -->
  <script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
</head>
<body>
  <!-- Skip to main content link for keyboard and screen reader users -->
  <a href="#mainContent" class="skip-link">Skip to main content</a>
  
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top" role="navigation" aria-label="Main Navigation">
    <div class="container">
      <a class="navbar-brand" href="#">Climate Data Downloader</a>
      <div class="d-flex">
        <!-- Help Menu Item with extra spacing -->
        <a href="#" class="nav-link text-white me-3" data-bs-toggle="modal" data-bs-target="#helpModal">Help</a>
        <!-- FAQ Menu Item -->
        <a href="#" class="nav-link text-white me-3" data-bs-toggle="modal" data-bs-target="#faqModal">FAQ</a>
        <!-- Features Menu Item -->
        <a href="#" class="nav-link text-white" data-bs-toggle="modal" data-bs-target="#featuresModal">Features</a>
      </div>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
              aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>
  
  <main id="mainContent" class="container my-5">
    <h1 class="text-center mb-4">Climate & Geo-Spatial Data Downloader</h1>
    
    <!-- Input Method Card -->
    <div class="card mb-4">
      <div class="card-header">Input Method</div>
      <div class="card-body">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="input_method" id="fillFormRadio" value="fill" checked>
          <label class="form-check-label" for="fillFormRadio">Fill out the form</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="input_method" id="uploadJSONRadio" value="upload">
          <label class="form-check-label" for="uploadJSONRadio">Upload JSON file</label>
        </div>
        <div id="uploadJSONContainer" class="mt-2" style="display: none;">
          <label for="uploadJSON" class="form-label">Select JSON file:</label>
          <input type="file" id="uploadJSON" class="form-control" accept=".json" aria-describedby="jsonHelp">
          <div id="jsonHelp" class="form-text">Upload a previously saved JSON to auto-fill the form.</div>
          <div class="mt-2">
            <button type="button" class="btn btn-info" id="loadJSONBtn">Load JSON</button>
            <button type="button" class="btn btn-danger" id="clearJSONBtn">Clear JSON Input</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Form -->
    <form id="mainForm">
      <!-- Data Parameters Card -->
      <div class="card mb-4">
        <div class="card-header">Data Parameters</div>
        <div class="card-body">
          <div class="row">
            <!-- Dataset Dropdown -->
            <div class="col-md-4 mb-3">
              <label for="dataset" class="form-label" data-bs-toggle="tooltip" title="Choose the dataset source (CHIRPS, CPC, TAMSAT, ARC, or GPCP)">Dataset:</label>
              <select id="dataset" name="dataset" class="form-select">
                <option value="CHIRPS">CHIRPS</option>
                <option value="CPC">CPC</option>
                <option value="TAMSAT">TAMSAT</option>
                <option value="ARC">ARC</option>
                <option value="GPCP">GPCP</option>
              </select>
            </div>
            <!-- Version Dropdown (populated dynamically) -->
            <div class="col-md-4 mb-3">
              <label for="version" class="form-label" data-bs-toggle="tooltip" title="For CHIRPS: choose between v2.0 and v3.0; for CPC: fixed to v1p0; for TAMSAT: fixed to v3p1; for ARC: fixed to ARC2; for GPCP: fixed to V2p3.">Version:</label>
              <select id="version" name="version" class="form-select"></select>
            </div>
            <!-- Frequency Dropdown (populated dynamically) -->
            <div class="col-md-4 mb-3">
              <label for="frequency" class="form-label" data-bs-toggle="tooltip" title="For CHIRPS: daily, dailyâ€‘improved, dekad, or monthly; for CPC: daily or monthly; for TAMSAT: daily, dekadal, or monthly; for ARC: daily or monthly; for GPCP: fixed to monthly.">Frequency:</label>
              <select id="frequency" name="frequency" class="form-select"></select>
            </div>
          </div>
          <div class="row">
            <!-- Resolution Dropdown (populated dynamically) -->
            <div class="col-md-4 mb-3">
              <label for="resolution" class="form-label" data-bs-toggle="tooltip" title="For CHIRPS: 0.05 or 0.25 (but for monthly frequency only 0.05 is allowed); for CPC: 0.5; for TAMSAT: 0.0375; for ARC: 0.1; for GPCP: 2.5.">Resolution:</label>
              <select id="resolution" name="resolution" class="form-select"></select>
            </div>
            <!-- Variable Dropdown (populated dynamically) -->
            <div class="col-md-4 mb-3">
              <label for="variable" class="form-label" data-bs-toggle="tooltip" title="For CPC:  
              - Daily: Precipitation, Maximum Temperature, Minimum Temperature  
              - Monthly: Precipitation, Maximum Temperature, Minimum Temperature, Mean Temperature  
              For CHIRPS, TAMSAT, ARC, and GPCP, fixed to precipitation (for monthly CHIRPS, variable is .precipitation).">Variable:</label>
              <select id="variable" name="variable" class="form-select"></select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Temporal Filtering Card -->
      <div class="card mb-4">
        <div class="card-header">Temporal Filtering</div>
        <div class="card-body">
          <h6>Start Date</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="start_day" class="form-label" data-bs-toggle="tooltip" title="Select the starting day">Day:</label>
              <select id="start_day" name="start_day" class="form-select"></select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="start_month" class="form-label" data-bs-toggle="tooltip" title="Select the starting month">Month:</label>
              <select id="start_month" name="start_month" class="form-select"></select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="start_year" class="form-label" data-bs-toggle="tooltip" title="For CPC & GPCP: start year begins at 1979; for CHIRPS: 1981; for TAMSAT & ARC: 1983">Year:</label>
              <select id="start_year" name="start_year" class="form-select"></select>
            </div>
          </div>
          <h6>End Date</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="end_day" class="form-label" data-bs-toggle="tooltip" title="Select the ending day">Day:</label>
              <select id="end_day" name="end_day" class="form-select"></select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="end_month" class="form-label" data-bs-toggle="tooltip" title="Select the ending month">Month:</label>
              <select id="end_month" name="end_month" class="form-select"></select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="end_year" class="form-label" data-bs-toggle="tooltip" title="For all datasets, use the user input value">Year:</label>
              <select id="end_year" name="end_year" class="form-select"></select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Spatial Filtering Card -->
      <div class="card mb-4">
        <div class="card-header">Spatial Filtering</div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="lon_min" class="form-label" data-bs-toggle="tooltip" title="Enter the minimum longitude (-180 to 179.95)">Longitude (min, degree east):</label>
              <input type="number" step="0.05" class="form-control" id="lon_min" name="lon_min" placeholder="-180" min="-180" max="179.95" value="-180" />
              <div class="invalid-feedback" aria-live="polite">Please enter a longitude between -180 and 179.95.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="lon_max" class="form-label" data-bs-toggle="tooltip" title="Enter the maximum longitude (-180 to 179.95)">Longitude (max, degree east):</label>
              <input type="number" step="0.05" class="form-control" id="lon_max" name="lon_max" placeholder="179.95" min="-180" max="179.95" value="179.95" />
              <div class="invalid-feedback" aria-live="polite">Please enter a longitude between -180 and 179.95.</div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="lat_min" class="form-label" data-bs-toggle="tooltip" title="Enter the minimum latitude (-49.975 to 49.975)">Latitude (min, degree north):</label>
              <input type="number" step="0.05" class="form-control" id="lat_min" name="lat_min" placeholder="-49.975" min="-49.975" max="49.975" value="-49.975" />
              <div class="invalid-feedback" aria-live="polite">Please enter a latitude between -49.975 and 49.975.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="lat_max" class="form-label" data-bs-toggle="tooltip" title="Enter the maximum latitude (-49.975 to 49.975)">Latitude (max, degree north):</label>
              <input type="number" step="0.05" class="form-control" id="lat_max" name="lat_max" placeholder="49.975" min="-49.975" max="49.975" value="49.975" />
              <div class="invalid-feedback" aria-live="polite">Please enter a latitude between -49.975 and 49.975.</div>
            </div>
          </div>
          <button type="button" class="btn btn-secondary" id="showSpatialBtn">Show Spatial Selection on Map</button>
          <div id="spatial_map"></div>
        </div>
      </div>
      
      <!-- Review Selections Button -->
      <button type="button" class="btn btn-primary w-100 mb-4" id="reviewSelections">Review Selections</button>
    </form>
    
    <!-- Confirmation Card -->
    <div class="card mb-4" id="confirmationCard">
      <div class="card-header">Review & Confirm</div>
      <div class="card-body">
        <p id="selectionSummary"></p>
        <button type="button" class="btn btn-secondary" id="goBackBtn">Go Back</button>
      </div>
    </div>
    
    <!-- Download Card -->
    <div class="card mb-4" id="urlCard" style="display: none;">
      <div class="card-header">Download NetCDF</div>
      <div class="card-body">
        <div id="spinner" class="spinner-border text-primary" role="status" style="display:none;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div id="spinnerText" style="display:none; text-align:center;">Download in progress...</div>
        <button type="button" class="btn btn-success w-100 mt-3" id="downloadBtn">Download NetCDF</button>
      </div>
    </div>
    
    <!-- Save Parameters Card -->
    <div class="card mb-4" id="saveLoadCard">
      <div class="card-header">Save Parameters</div>
      <div class="card-body">
        <button type="button" class="btn btn-warning w-100" id="saveParamsBtn">Download Parameters as JSON</button>
      </div>
    </div>
    
  </main>
  
  <!-- Help Modal -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="helpModalLabel">How to Use This Application</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h3>Overview</h3>
          <p>This tool allows you to download climate and geoâ€‘spatial data from various sources including CHIRPS, CPC, TAMSAT, ARC, and GPCP. You can customize your download by selecting dataset parameters, temporal and spatial filters, review your settings, and download the corresponding NetCDF file.</p>
          <h4>Step-by-Step Guide</h4>
          <ol>
            <li>
              <strong>Input Method:</strong>
              <ul>
                <li>Fill out the form manually or upload a saved JSON file to preâ€‘populate the fields.</li>
              </ul>
            </li>
            <li>
              <strong>Data Parameters:</strong>
              <ul>
                <li>Select your <em>Dataset</em> (CHIRPS, CPC, TAMSAT, ARC, or GPCP).</li>
                <li>The <em>Version</em>, <em>Frequency</em>, and <em>Resolution</em> fields update automatically based on the selected dataset.
                  <ul>
                    <li>For CHIRPS: If version <em>v3.0</em> or <em>v2.0</em> is selected and frequency is monthly, only <em>monthly</em> is allowed, the resolution is fixed to <em>0.05</em> (and omitted from the URL), and the variable is set to <em>.precipitation</em>.</li>
                  </ul>
                </li>
                <li>For CPC, additional temperature options appear in the <em>Variable</em> dropdown based on frequency.</li>
              </ul>
            </li>
            <li>
              <strong>Temporal Filtering:</strong>
              <ul>
                <li>Select the <em>Start Date</em> (day, month, and year) and <em>End Date</em> from the dropdowns. Note that available start years differ by dataset:
                  <ul>
                    <li>CPC & GPCP: begin at <strong>1979</strong></li>
                    <li>CHIRPS: begin at <strong>1981</strong></li>
                    <li>TAMSAT & ARC: begin at <strong>1983</strong></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li>
              <strong>Spatial Filtering:</strong>
              <ul>
                <li>Enter the minimum and maximum longitude and latitude values for your area of interest.</li>
                <li>Click the <em>Show Spatial Selection on Map</em> button to visualize your selected bounding box.</li>
              </ul>
            </li>
            <li>
              <strong>Review & Confirm:</strong>
              <ul>
                <li>Click <em>Review Selections</em> to view a summary of your parameters.</li>
                <li>If any changes are needed, click <em>Go Back</em> to edit your selections.</li>
              </ul>
            </li>
            <li>
              <strong>Download NetCDF:</strong>
              <ul>
                <li>Once you confirm your selections, click <em>Download NetCDF</em>. The application will internally construct the download URL and fetch your data file. A spinner will indicate that the download is in progress.</li>
              </ul>
            </li>
            <li>
              <strong>Save/Load Parameters:</strong>
              <ul>
                <li>You can download your current parameters as a JSON file using a file name in the format <code>Dataset_Version_Frequency_Resolution_Variable.json</code>.</li>
              </ul>
            </li>
          </ol>
          <p>Once you verify and debug all the links and the code, you can remove or comment out any URL debug display if desired.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- FAQ Modal -->
  <div class="modal fade" id="faqModal" tabindex="-1" aria-labelledby="faqModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="faqModalLabel">FAQ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul>
            <li><strong>Dataset:</strong> Choose between CHIRPS, CPC, TAMSAT, ARC, and GPCP data sources.</li>
            <li><strong>Version:</strong>
              <ul>
                <li>CHIRPS: choose between v2.0 and v3.0</li>
                <li>CPC: fixed to v1p0</li>
                <li>TAMSAT: fixed to v3p1</li>
                <li>ARC: fixed to ARC2</li>
                <li>GPCP: fixed to V2p3</li>
              </ul>
            </li>
            <li><strong>Frequency:</strong>
              <ul>
                <li>CHIRPS: daily, dailyâ€‘improved, dekad, or monthly</li>
                <li>CPC: daily or monthly</li>
                <li>TAMSAT: daily, dekadal, or monthly</li>
                <li>ARC: daily or monthly</li>
                <li>GPCP: fixed to monthly</li>
              </ul>
            </li>
            <li><strong>Resolution:</strong>
              <ul>
                <li>CHIRPS: For monthly frequency (both v2.0 and v3.0) only 0.05 is allowed (the resolution parameter is omitted from the URL)</li>
                <li>CPC: 0.5</li>
                <li>TAMSAT: 0.0375</li>
                <li>ARC: 0.1</li>
                <li>GPCP: 2.5</li>
              </ul>
            </li>
            <li><strong>Variable:</strong>
              <ul>
                <li>CPC:
                  <ul>
                    <li>Daily: Precipitation, Maximum Temperature, Minimum Temperature</li>
                    <li>Monthly: Precipitation, Maximum Temperature, Minimum Temperature, Mean Temperature</li>
                  </ul>
                </li>
                <li>CHIRPS, TAMSAT, ARC, GPCP: fixed to precipitation (for monthly CHIRPS, variable is set to <em>.precipitation</em>)</li>
              </ul>
            </li>
            <li><strong>Temporal Filtering:</strong>
              <ul>
                <li>CPC & GPCP: start year begins at 1979</li>
                <li>CHIRPS: start year begins at 1981</li>
                <li>TAMSAT & ARC: start year begins at 1983</li>
                <li>The end date is taken from user input.</li>
              </ul>
            </li>
            <li><strong>Spatial Filtering:</strong> Define the geographic area using latitude and longitude.</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Features Modal -->
  <div class="modal fade" id="featuresModal" tabindex="-1" aria-labelledby="featuresModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="featuresModalLabel">Application Features & Tech Stack</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h4>Key Features</h4>
          <ul>
            <li><strong>Responsive and Modern UI:</strong> Built using Bootstrap 5 with the Flatly theme for a clean, mobile-friendly design.</li>
            <li><strong>Dynamic Form Inputs:</strong> The form automatically updates options based on dataset selection, version, frequency, and resolution.</li>
            <li><strong>Interactive Mapping:</strong> Integration with Leaflet for spatial selection visualization.</li>
            <li><strong>Robust Download Handling:</strong> Internally constructs download URLs, uses caching, and shows a spinner during downloads.</li>
            <li><strong>Save/Load Parameters:</strong> Users can save their selections as JSON for later reuse.</li>
          </ul>
          <h4>Tech Stack</h4>
          <ul>
            <li><strong>HTML5 & CSS3:</strong> Structure and styling of the application.</li>
            <li><strong>Bootstrap 5:</strong> Responsive layout and UI components.</li>
            <li><strong>Bootswatch Flatly Theme:</strong> Custom, modern design for enhanced user experience.</li>
            <li><strong>JavaScript:</strong> Dynamic form handling, URL construction, and file download logic.</li>
            <li><strong>Leaflet:</strong> Interactive mapping and spatial data visualization.</li>
            <li><strong>shp.js:</strong> (Optional) For shapefile processing if needed.</li>
          </ul>
          <p>This application is designed to be modular and scalable, allowing for future enhancements and integration with additional data sources and visualization tools.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap 5 JS Bundle (includes Popper) and Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Toggle Input Method (JSON upload)
      const fillFormRadio = document.getElementById("fillFormRadio");
      const uploadJSONRadio = document.getElementById("uploadJSONRadio");
      const uploadJSONContainer = document.getElementById("uploadJSONContainer");
      const loadJSONBtn = document.getElementById("loadJSONBtn");
      const clearJSONBtn = document.getElementById("clearJSONBtn");

      function toggleInputMethod() {
        uploadJSONContainer.style.display = uploadJSONRadio.checked ? "block" : "none";
      }

      fillFormRadio.addEventListener("change", toggleInputMethod);
      uploadJSONRadio.addEventListener("change", toggleInputMethod);
      toggleInputMethod();

      // --- JSON File Load & Clear Functionality ---
      loadJSONBtn.addEventListener("click", function() {
        const file = document.getElementById("uploadJSON").files[0];
        if (!file) {
          alert("Please select a JSON file.");
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const params = JSON.parse(e.target.result);
            document.getElementById("dataset").value = params.dataset || "";
            document.getElementById("version").value = params.version || "";
            document.getElementById("frequency").value = params.frequency || "";
            document.getElementById("resolution").value = params.resolution || "";
            document.getElementById("variable").value = params.variable || "";
            document.getElementById("start_day").value = params.start_day || "";
            document.getElementById("start_month").value = params.start_month || "";
            document.getElementById("start_year").value = params.start_year || "";
            document.getElementById("end_day").value = params.end_day || "";
            document.getElementById("end_month").value = params.end_month || "";
            document.getElementById("end_year").value = params.end_year || "";
            document.getElementById("lon_min").value = params.lon_min || "";
            document.getElementById("lon_max").value = params.lon_max || "";
            document.getElementById("lat_min").value = params.lat_min || "";
            document.getElementById("lat_max").value = params.lat_max || "";
            alert("Parameters loaded successfully.");
            updateDatasetDependentOptions();
          } catch (err) {
            alert("Error loading JSON file.");
            console.error(err);
          }
        };
        reader.readAsText(file);
      });
      
      clearJSONBtn.addEventListener("click", function() {
        document.getElementById("uploadJSON").value = "";
        fillFormRadio.checked = true;
        toggleInputMethod();
        alert("JSON input cleared. You can now fill out the form.");
      });

      // --- Update Version Options based on Dataset ---
      function updateVersionOptions() {
        const dataset = document.getElementById("dataset").value;
        const versionSelect = document.getElementById("version");
        versionSelect.innerHTML = "";
        if (dataset === "CPC") {
          let opt = document.createElement("option");
          opt.value = "v1p0";
          opt.text = "v1p0";
          versionSelect.appendChild(opt);
          versionSelect.disabled = true;
        } else if (dataset === "TAMSAT") {
          let opt = document.createElement("option");
          opt.value = "v3p1";
          opt.text = "v3p1";
          versionSelect.appendChild(opt);
          versionSelect.disabled = true;
        } else if (dataset === "ARC") {
          let opt = document.createElement("option");
          opt.value = "ARC2";
          opt.text = "ARC2";
          versionSelect.appendChild(opt);
          versionSelect.disabled = true;
        } else if (dataset === "GPCP") {
          let opt = document.createElement("option");
          opt.value = "V2p3";
          opt.text = "V2p3";
          versionSelect.appendChild(opt);
          versionSelect.disabled = true;
        } else { // CHIRPS
          let opt1 = document.createElement("option");
          opt1.value = "v2.0";
          opt1.text = "v2.0";
          versionSelect.appendChild(opt1);
          let opt2 = document.createElement("option");
          opt2.value = "v3.0";
          opt2.text = "v3p0";
          versionSelect.appendChild(opt2);
          versionSelect.disabled = false;
        }
      }
      
      // --- Update Frequency Options based on Dataset and (for CHIRPS) Version ---
      function updateFrequencyOptions() {
        const dataset = document.getElementById("dataset").value;
        const frequencySelect = document.getElementById("frequency");
        frequencySelect.innerHTML = "";
        if (dataset === "CPC") {
          let optDaily = document.createElement("option");
          optDaily.value = "daily";
          optDaily.text = "daily";
          frequencySelect.appendChild(optDaily);
          let optMonthly = document.createElement("option");
          optMonthly.value = "monthly";
          optMonthly.text = "monthly";
          frequencySelect.appendChild(optMonthly);
          frequencySelect.disabled = false;
        } else if (dataset === "TAMSAT") {
          const options = ["daily", "dekadal", "monthly"];
          options.forEach(optText => {
            let opt = document.createElement("option");
            opt.value = optText;
            opt.text = optText;
            frequencySelect.appendChild(opt);
          });
          frequencySelect.disabled = false;
        } else if (dataset === "ARC") {
          const options = ["daily", "monthly"];
          options.forEach(optText => {
            let opt = document.createElement("option");
            opt.value = optText;
            opt.text = optText;
            frequencySelect.appendChild(opt);
          });
          frequencySelect.disabled = false;
        } else if (dataset === "GPCP") {
          let opt = document.createElement("option");
          opt.value = "monthly";
          opt.text = "monthly";
          frequencySelect.appendChild(opt);
          frequencySelect.disabled = true;
        } else { // CHIRPS
          const versionVal = document.getElementById("version").value;
          if (versionVal === "v3.0") {
            let opt = document.createElement("option");
            opt.value = "monthly";
            opt.text = "monthly";
            frequencySelect.appendChild(opt);
            frequencySelect.disabled = true;
          } else {
            const options = ["daily", "daily-improved", "dekad", "monthly"];
            options.forEach(optText => {
              let opt = document.createElement("option");
              opt.value = optText;
              opt.text = optText;
              frequencySelect.appendChild(opt);
            });
            frequencySelect.disabled = false;
          }
        }
      }
      
      // --- Update Resolution Options based on Dataset and (for CHIRPS) Version & Frequency ---
      function updateResolutionOptions() {
        const dataset = document.getElementById("dataset").value;
        const resolutionSelect = document.getElementById("resolution");
        resolutionSelect.innerHTML = "";
        if (dataset === "CPC") {
          let opt = document.createElement("option");
          opt.value = "0.5";
          opt.text = "0.5";
          resolutionSelect.appendChild(opt);
          resolutionSelect.disabled = true;
        } else if (dataset === "TAMSAT") {
          let opt = document.createElement("option");
          opt.value = "0.0375";
          opt.text = "0.0375";
          resolutionSelect.appendChild(opt);
          resolutionSelect.disabled = true;
        } else if (dataset === "ARC") {
          let opt = document.createElement("option");
          opt.value = "0.1";
          opt.text = "0.1";
          resolutionSelect.appendChild(opt);
          resolutionSelect.disabled = true;
        } else if (dataset === "GPCP") {
          let opt = document.createElement("option");
          opt.value = "2.5";
          opt.text = "2.5";
          resolutionSelect.appendChild(opt);
          resolutionSelect.disabled = true;
        } else { // CHIRPS
          const frequency = document.getElementById("frequency").value;
          if (frequency === "monthly") {
            resolutionSelect.innerHTML = "";
            let opt = document.createElement("option");
            opt.value = "0.05";
            opt.text = "0.05";
            resolutionSelect.appendChild(opt);
            resolutionSelect.disabled = true;
          } else {
            const options = ["0.05", "0.25"];
            options.forEach(optText => {
              let opt = document.createElement("option");
              opt.value = optText;
              opt.text = optText;
              resolutionSelect.appendChild(opt);
            });
            resolutionSelect.disabled = false;
          }
        }
      }
      
      // --- Update Variable Options based on Dataset and Frequency ---
      function updateVariableOptions() {
        const dataset = document.getElementById("dataset").value;
        const frequency = document.getElementById("frequency").value;
        const variableField = document.getElementById("variable");
        variableField.innerHTML = "";
        if (dataset === "CPC") {
          let optPrecip = document.createElement("option");
          optPrecip.value = "precipitation";
          optPrecip.text = "Precipitation";
          variableField.appendChild(optPrecip);
          if (frequency === "daily") {
            let optMax = document.createElement("option");
            optMax.value = "max_temp";
            optMax.text = "Maximum Temperature";
            let optMin = document.createElement("option");
            optMin.value = "min_temp";
            optMin.text = "Minimum Temperature";
            variableField.appendChild(optMax);
            variableField.appendChild(optMin);
          } else if (frequency === "monthly") {
            let optMax = document.createElement("option");
            optMax.value = "max_temp";
            optMax.text = "Maximum Temperature";
            let optMin = document.createElement("option");
            optMin.value = "min_temp";
            optMin.text = "Minimum Temperature";
            let optMean = document.createElement("option");
            optMean.value = "mean_temp";
            optMean.text = "Mean Temperature";
            variableField.appendChild(optMax);
            variableField.appendChild(optMin);
            variableField.appendChild(optMean);
          }
          variableField.disabled = false;
        } else if (dataset === "TAMSAT" || dataset === "CHIRPS" || dataset === "ARC" || dataset === "GPCP") {
          let opt = document.createElement("option");
          if (dataset === "CHIRPS" && frequency === "monthly") {
            opt.value = "precipitation";
            opt.text = "precipitation";
          } else {
            opt.value = "precipitation";
            opt.text = "precipitation";
          }
          variableField.appendChild(opt);
          variableField.disabled = true;
        }
      }
      
      // --- Update Temporal Filtering Dropdowns based on Dataset ---
      function populateTemporalFilters() {
        const dataset = document.getElementById("dataset").value;
        let startYearValue;
        if (dataset === "CPC" || dataset === "GPCP") {
          startYearValue = 1979;
        } else if (dataset === "CHIRPS") {
          startYearValue = 1981;
        } else if (dataset === "TAMSAT" || dataset === "ARC") {
          startYearValue = 1983;
        }
        const endYearValue = 2025;
        
        const startDaySelect = document.getElementById("start_day");
        const endDaySelect = document.getElementById("end_day");
        startDaySelect.innerHTML = "";
        endDaySelect.innerHTML = "";
        for (let d = 1; d <= 31; d++) {
          let dayStr = d.toString().padStart(2, '0');
          let opt1 = document.createElement("option");
          opt1.value = dayStr;
          opt1.text = dayStr;
          startDaySelect.appendChild(opt1);
          let opt2 = document.createElement("option");
          opt2.value = dayStr;
          opt2.text = dayStr;
          endDaySelect.appendChild(opt2);
        }
        
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const startMonthSelect = document.getElementById("start_month");
        const endMonthSelect = document.getElementById("end_month");
        startMonthSelect.innerHTML = "";
        endMonthSelect.innerHTML = "";
        months.forEach(m => {
          let opt1 = document.createElement("option");
          opt1.value = m;
          opt1.text = m;
          startMonthSelect.appendChild(opt1);
          let opt2 = document.createElement("option");
          opt2.value = m;
          opt2.text = m;
          endMonthSelect.appendChild(opt2);
        });
        
        const startYearSelect = document.getElementById("start_year");
        const endYearSelect = document.getElementById("end_year");
        startYearSelect.innerHTML = "";
        endYearSelect.innerHTML = "";
        for (let y = startYearValue; y <= endYearValue; y++) {
          let opt1 = document.createElement("option");
          opt1.value = y;
          opt1.text = y;
          startYearSelect.appendChild(opt1);
          let opt2 = document.createElement("option");
          opt2.value = y;
          opt2.text = y;
          endYearSelect.appendChild(opt2);
        }
        if (dataset === "CPC") {
          let presentOpt = document.createElement("option");
          presentOpt.value = "Present";
          presentOpt.text = "Present";
          endYearSelect.appendChild(presentOpt);
        }
      }
      
      // --- Update all dataset-dependent options ---
      function updateDatasetDependentOptions() {
        updateVersionOptions();
        updateFrequencyOptions();
        updateResolutionOptions();
        populateTemporalFilters();
        updateVariableOptions();
      }
      
      updateDatasetDependentOptions();
      document.getElementById("dataset").addEventListener("change", updateDatasetDependentOptions);
      document.getElementById("frequency").addEventListener("change", function(){
        updateVariableOptions();
        updateResolutionOptions();
      });
      document.getElementById("version").addEventListener("change", function() {
        updateFrequencyOptions();
        updateResolutionOptions();
      });
      
      // --- REVIEW & CONFIRM LOGIC ---
      const reviewBtn = document.getElementById("reviewSelections");
      const confirmCard = document.getElementById("confirmationCard");
      const selectionP = document.getElementById("selectionSummary");
      const goBackBtn = document.getElementById("goBackBtn");
      
      reviewBtn.addEventListener("click", function () {
        reviewBtn.style.display = "none";
        
        let datasetSel = document.getElementById("dataset").value;
        let versionFriendly = document.getElementById("version").value;
        let frequencyFriendly = document.getElementById("frequency").value;
        let resolutionFriendly = document.getElementById("resolution").value;
        let variableFriendly = document.getElementById("variable").value;
        
        let start_day = document.getElementById("start_day").value;
        let start_month = document.getElementById("start_month").value;
        let start_year = document.getElementById("start_year").value;
        let end_day = document.getElementById("end_day").value;
        let end_month = document.getElementById("end_month").value;
        let end_year = document.getElementById("end_year").value;
        let temporal = `Start: ${start_day} ${start_month} ${start_year} to End: ${end_day} ${end_month} ${end_year}`;
        
        let lonMin = document.getElementById("lon_min").value;
        let lonMax = document.getElementById("lon_max").value;
        let latMin = document.getElementById("lat_min").value;
        let latMax = document.getElementById("lat_max").value;
        let spatial = `Longitude: ${lonMin} to ${lonMax} degree east, Latitude: ${latMin} to ${latMax} degree north`;
        
        let summary = `
          <h5>Your Selections:</h5>
          <ul>
            <li><strong>Dataset:</strong> ${datasetSel}</li>
            <li><strong>Version:</strong> ${versionFriendly}</li>
            <li><strong>Frequency:</strong> ${frequencyFriendly}</li>
            <li><strong>Resolution:</strong> ${resolutionFriendly}</li>
            <li><strong>Variable:</strong> ${variableFriendly}</li>
            <li><strong>Temporal Filter:</strong> ${temporal}</li>
            <li><strong>Spatial Filter:</strong> ${spatial}</li>
          </ul>
        `;
        selectionP.innerHTML = summary;
        confirmCard.style.display = "block";
        // Show the download card which now only contains the Download NetCDF button
        document.getElementById("urlCard").style.display = "block";
      });
      
      goBackBtn.addEventListener("click", function () {
        confirmCard.style.display = "none";
        reviewBtn.style.display = "block";
      });
      
      // --- URL CONSTRUCTION & DOWNLOAD ---
      const downloadBtn = document.getElementById("downloadBtn");
      
      function constructURL() {
        const baseURL = "https://iridl.ldeo.columbia.edu/SOURCES/";
        const datasetSel = document.getElementById("dataset").value;
        const start_day = document.getElementById("start_day").value;
        const start_month = document.getElementById("start_month").value;
        const start_year = document.getElementById("start_year").value;
        const end_day = document.getElementById("end_day").value;
        const end_month = document.getElementById("end_month").value;
        const end_year = document.getElementById("end_year").value;
        const lonMin = document.getElementById("lon_min").value;
        const lonMax = document.getElementById("lon_max").value;
        const latMin = document.getElementById("lat_min").value;
        const latMax = document.getElementById("lat_max").value;
        
        // CPC branch
        if (datasetSel === "CPC") {
          const frequency = document.getElementById("frequency").value;
          const variable = document.getElementById("variable").value;
          let cpcSegment = "";
          if (frequency === "daily") {
            if (variable === "max_temp") {
              cpcSegment = ".temperature/.daily/.tmax";
            } else if (variable === "min_temp") {
              cpcSegment = ".temperature/.daily/.tmin";
            } else {
              cpcSegment = ".UNIFIED_PRCP/.GAUGE_BASED/.GLOBAL/.v1p0/.REALTIME/.rain";
            }
          } else if (frequency === "monthly") {
            if (variable === "max_temp") {
              cpcSegment = ".temperature/.monthly/.tmax";
            } else if (variable === "min_temp") {
              cpcSegment = ".temperature/.monthly/.tmin";
            } else if (variable === "mean_temp") {
              cpcSegment = ".temperature/.monthly/.tmean";
            } else {
              cpcSegment = ".UNIFIED_PRCP/.GAUGE_BASED/.GLOBAL/.v1p0/.REALTIME/.rain";
            }
          } else {
            cpcSegment = ".UNIFIED_PRCP/.GAUGE_BASED/.GLOBAL/.v1p0/.REALTIME/.rain";
          }
          
          return "https://iridl.ldeo.columbia.edu/SOURCES/.NOAA/.NCEP/.CPC/" + cpcSegment +
                 "/X/" + lonMin + "/" + lonMax + "/RANGE/" +
                 "Y/" + latMin + "/" + latMax + "/RANGE/" +
                 "T/(" + start_day + "%20" + start_month + "%20" + start_year + ")/(" +
                 end_day + "%20" + end_month + "%20" + end_year + ")/RANGE/data.nc";
        }
        
        // TAMSAT branch
        if (datasetSel === "TAMSAT") {
          const frequency = document.getElementById("frequency").value;
          let frequencySegment = "";
          switch (frequency) {
            case "daily":
              frequencySegment = ".daily";
              break;
            case "dekadal":
              frequencySegment = ".dekadal";
              break;
            case "monthly":
              frequencySegment = ".monthly";
              break;
          }
          const fixedBase = "https://iridl.ldeo.columbia.edu/SOURCES/.Reading/.Meteorology/.TAMSAT/.v3p1";
          const rfeSegment = "/.rfe_filled";
          const spatialSegment = "/X/" + lonMin + "/" + lonMax + "/RANGE/Y/" + latMin + "/" + latMax + "/RANGE/";
          let timeSegment = "";
          if (frequency === "daily") {
            timeSegment = "T/(" + start_day + "%20" + start_month + "%20" + start_year + ")/(" +
                          end_day + "%20" + end_month + "%20" + end_year + ")/RANGE/data.nc";
          } else {
            timeSegment = "T/(" + start_month + "%20" + start_year + ")/(" +
                          end_month + "%20" + end_year + ")/RANGE/data.nc";
          }
          return fixedBase + "/" + frequencySegment + rfeSegment + spatialSegment + timeSegment;
        }
        
        // ARC branch
        if (datasetSel === "ARC") {
          const frequency = document.getElementById("frequency").value;
          let frequencySegment = "";
          let timeSegment = "";
          if (frequency === "daily") {
            frequencySegment = ".daily";
            timeSegment = "T/(" + start_day + "%20" + start_month + "%20" + start_year + ")/(" +
                          end_day + "%20" + end_month + "%20" + end_year + ")/RANGE/data.nc";
          } else if (frequency === "monthly") {
            frequencySegment = ".monthly";
            timeSegment = "T/(" + start_month + "%20" + start_year + ")/(" +
                          end_month + "%20" + end_year + ")/RANGE/data.nc";
          }
          return "https://iridl.ldeo.columbia.edu/SOURCES/.NOAA/.NCEP/.CPC/.FEWS/.Africa/.DAILY/.ARC2" +
                 "/" + frequencySegment +
                 "/.est_prcp" +
                 "/X/" + lonMin + "/" + lonMax + "/RANGE/" +
                 "Y/" + latMin + "/" + latMax + "/RANGE/" +
                 timeSegment;
        }
        
        // GPCP branch
        if (datasetSel === "GPCP") {
          return "https://iridl.ldeo.columbia.edu/SOURCES/.NASA/.GPCP/.V2p3/.CDR-NCEI/.full/.precip" +
                 "/X/" + lonMin + "/" + lonMax + "/RANGE/" +
                 "Y/" + latMin + "/" + latMax + "/RANGE/" +
                 "T/(" + start_month + "%20" + start_year + ")/(" +
                 end_month + "%20" + end_year + ")/RANGE/data.nc";
        }
        
        // CHIRPS branch
        let sourceParam = ".UCSB";
        let datasetParam = ".CHIRPS";
        let versionVal = document.getElementById("version").value;
        let versionParam = (versionVal === "v2.0") ? ".v2p0" : ".v3p0";
        let frequencyVal = document.getElementById("frequency").value;
        let frequencyParam = "";
        switch (frequencyVal) {
          case "daily": frequencyParam = ".daily"; break;
          case "daily-improved": frequencyParam = ".daily-improved"; break;
          case "dekad": frequencyParam = ".dekad"; break;
          case "monthly": frequencyParam = ".monthly"; break;
        }
        let scopeParam = "";
        if (frequencyVal !== "dekad") {
          scopeParam = ".global";
        }
        let timePart = "T/" + start_day + "%20" + start_month + "%20" + start_year + "/" +
                       end_day + "%20" + end_month + "%20" + end_year + "/RANGE/data.nc";
        let variableParam = ".prcp"; // default for CHIRPS
        
        // For CHIRPS monthly, remove the resolution segment and use .precipitation
        if (frequencyVal === "monthly") {
          variableParam = ".precipitation";
          return baseURL +
                 sourceParam + "/" +
                 datasetParam + "/" +
                 versionParam + "/" +
                 frequencyParam + "/" +
                 scopeParam + "/" +
                 variableParam +
                 "/X/" + lonMin + "/" + lonMax + "/RANGE/" +
                 "Y/" + latMin + "/" + latMax + "/RANGE/" +
                 timePart;
        } else {
          return baseURL +
                 sourceParam + "/" +
                 datasetParam + "/" +
                 versionParam + "/" +
                 frequencyParam + "/" +
                 scopeParam + "/" +
                 (document.getElementById("resolution").value === "0.05" ? ".0p05" : ".0p25") + "/" +
                 variableParam +
                 "/X/" + lonMin + "/" + lonMax + "/RANGE/" +
                 "Y/" + latMin + "/" + latMax + "/RANGE/" +
                 timePart;
        }
      }
      
      if (downloadBtn) {
        downloadBtn.addEventListener("click", function() {
          const url = constructURL();
          console.log("Constructed URL (for debugging):", url);
          document.getElementById("spinner").style.display = "inline-block";
          document.getElementById("spinnerText").style.display = "block";
          if ('caches' in window) {
            caches.open('dataCache').then(cache => {
              cache.match(url).then(cachedResponse => {
                if (cachedResponse) {
                  return cachedResponse.blob();
                } else {
                  return fetch(url).then(response => {
                    if (!response.ok) {
                      throw new Error("Network response was not ok: " + response.statusText);
                    }
                    cache.put(url, response.clone());
                    return response.blob();
                  });
                }
              }).then(blob => {
                document.getElementById("spinner").style.display = "none";
                document.getElementById("spinnerText").style.display = "none";
                let fileName;
                const datasetSel = document.getElementById("dataset").value;
                const versionFriendly = document.getElementById("version").value;
                const frequencyFriendly = document.getElementById("frequency").value;
                const resolutionFriendly = document.getElementById("resolution").value;
                const variableFriendly = document.getElementById("variable").value;
                if (datasetSel === "CHIRPS" && versionFriendly === "v2.0" && frequencyFriendly === "monthly") {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else if (datasetSel === "CHIRPS" && versionFriendly === "v2.0" && frequencyFriendly === "dekad") {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else if (datasetSel === "CHIRPS" && versionFriendly === "v2.0" && (frequencyFriendly === "daily" || frequencyFriendly === "daily-improved")) {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else if (datasetSel === "CHIRPS" && versionFriendly === "v3p0" && frequencyFriendly === "monthly") {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else if (datasetSel === "GPCP") {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${resolutionFriendly}_${variableFriendly}.nc`;
                }
                const a = document.createElement("a");
                const urlBlob = window.URL.createObjectURL(blob);
                a.href = urlBlob;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(urlBlob);
              }).catch(error => {
                document.getElementById("spinner").style.display = "none";
                document.getElementById("spinnerText").style.display = "none";
                alert("Download failed: " + error.message);
                console.error("Download error:", error);
              });
            });
          } else {
            fetch(url)
              .then(response => {
                if (!response.ok) {
                  throw new Error("Network response was not ok: " + response.statusText);
                }
                return response.blob();
              })
              .then(blob => {
                document.getElementById("spinner").style.display = "none";
                document.getElementById("spinnerText").style.display = "none";
                let fileName;
                const datasetSel = document.getElementById("dataset").value;
                const versionFriendly = document.getElementById("version").value;
                const frequencyFriendly = document.getElementById("frequency").value;
                const resolutionFriendly = document.getElementById("resolution").value;
                const variableFriendly = document.getElementById("variable").value;
                if (datasetSel === "CHIRPS" && versionFriendly === "v2.0" && frequencyFriendly === "monthly") {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else if (datasetSel === "CHIRPS" && versionFriendly === "v2.0" && frequencyFriendly === "dekad") {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else if (datasetSel === "CHIRPS" && versionFriendly === "v2.0" && (frequencyFriendly === "daily" || frequencyFriendly === "daily-improved")) {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else if (datasetSel === "CHIRPS" && versionFriendly === "v3p0" && frequencyFriendly === "monthly") {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else if (datasetSel === "GPCP") {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${variableFriendly}.nc`;
                } else {
                  fileName = `${datasetSel}_${versionFriendly}_${frequencyFriendly}_${resolutionFriendly}_${variableFriendly}.nc`;
                }
                const a = document.createElement("a");
                const urlBlob = window.URL.createObjectURL(blob);
                a.href = urlBlob;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(urlBlob);
              })
              .catch(error => {
                document.getElementById("spinner").style.display = "none";
                document.getElementById("spinnerText").style.display = "none";
                alert("Download failed: " + error.message);
                console.error("Download error:", error);
              });
          }
        });
      }
      
      // --- Save Parameters as JSON with dynamic file name ---
      const saveParamsBtn = document.getElementById("saveParamsBtn");
      function getFormParameters() {
        return {
          dataset: document.getElementById("dataset").value,
          version: document.getElementById("version").value,
          frequency: document.getElementById("frequency").value,
          resolution: document.getElementById("resolution").value,
          variable: document.getElementById("variable").value,
          start_day: document.getElementById("start_day").value,
          start_month: document.getElementById("start_month").value,
          start_year: document.getElementById("start_year").value,
          end_day: document.getElementById("end_day").value,
          end_month: document.getElementById("end_month").value,
          end_year: document.getElementById("end_year").value,
          lon_min: document.getElementById("lon_min").value,
          lon_max: document.getElementById("lon_max").value,
          lat_min: document.getElementById("lat_min").value,
          lat_max: document.getElementById("lat_max").value
        };
      }
      saveParamsBtn.addEventListener("click", function() {
        const params = getFormParameters();
        const jsonStr = JSON.stringify(params, null, 2);
        const dataUri = 'data:text/json;charset=utf-8,' + encodeURIComponent(jsonStr);
        const datasetName = document.getElementById("dataset").value;
        const versionName = document.getElementById("version").value;
        const frequencyName = document.getElementById("frequency").value;
        const resolutionName = document.getElementById("resolution").value;
        const variableName = document.getElementById("variable").value;
        const fileName = `${datasetName}_${versionName}_${frequencyName}_${resolutionName}_${variableName}.json`;
        const a = document.createElement("a");
        a.href = dataUri;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
      });
      
      // --- DATASET SELECTION Logging ---
      document.getElementById("dataset").addEventListener("change", function () {
        console.log("Dataset changed to:", this.value);
        if (this.value === "CHIRPS") {
          console.log("CHIRPS selected. Saving parameters: Source = .UCSB, Dataset = .CHIRPS");
        }
      });
      let ds = document.getElementById("dataset").value;
      if (ds === "CHIRPS") {
        console.log("CHIRPS selected on load. Saving parameters: Source = .UCSB, Dataset = .CHIRPS");
      }
      
      // --- SPATIAL MAP DISPLAY (Red Rectangular Box) ---
      let spatialMap;
      let spatialRectangle;
      function initSpatialMap() {
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' });
        const cartoPositron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap contributors &copy; CARTO' });
        const cartoDarkMatter = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap contributors &copy; CARTO' });
        const esriWorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
        const esriWorldTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
        
        spatialMap = L.map("spatial_map", {
          center: [0, 0],
          zoom: 2,
          layers: [osm]
        });
        L.control.layers({
          "OpenStreetMap": osm,
          "Carto Positron": cartoPositron,
          "Carto Dark Matter": cartoDarkMatter,
          "ESRI World Imagery": esriWorldImagery,
          "ESRI World Topo": esriWorldTopo
        }).addTo(spatialMap);
      }
      
      document.getElementById("showSpatialBtn").addEventListener("click", function () {
        if (!spatialMap) { initSpatialMap(); }
        let lonMin = parseFloat(document.getElementById("lon_min").value);
        let lonMax = parseFloat(document.getElementById("lon_max").value);
        let latMin = parseFloat(document.getElementById("lat_min").value);
        let latMax = parseFloat(document.getElementById("lat_max").value);
        
        if (isNaN(lonMin) || isNaN(lonMax) || isNaN(latMin) || isNaN(latMax)) {
          alert("Please enter valid spatial values.");
          return;
        }
        
        const bounds = [[latMin, lonMin], [latMax, lonMax]];
        console.log("Showing rectangle with bounds:", bounds);
        if (spatialRectangle) {
          spatialMap.removeLayer(spatialRectangle);
        }
        spatialRectangle = L.rectangle(bounds, { color: "red", weight: 2 });
        spatialRectangle.addTo(spatialMap).bringToFront();
        spatialMap.fitBounds(bounds);
      });
    });
  </script>
  
</body>
</html>
